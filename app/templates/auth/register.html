{% extends "base.html" %}

{% block public_content %}
<div class="w-full max-w-lg" x-data="registrationWizard('{{ invitation_token or '' }}', {{ invitation_data | tojson if invitation_data else 'null' }})">
    <div class="mb-8">
        <h1 class="text-center text-3xl font-bold tracking-tight text-primary-600">{{ app_name }}</h1>
        <h2 class="mt-4 text-center text-2xl font-bold tracking-tight text-gray-900">Create your account</h2>
        <p class="mt-2 text-center text-sm text-gray-600">
            Already have an account?
            <a href="/login" class="font-medium text-primary-600 hover:text-primary-500">Sign in</a>
        </p>
    </div>

    <!-- Invitation Banner -->
    <template x-if="invitationData">
        <div class="mb-6 rounded-md bg-blue-50 border border-blue-200 p-4">
            <div class="flex">
                <svg class="h-5 w-5 text-blue-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                <div class="ml-3">
                    <p class="text-sm font-medium text-blue-800" x-text="invitationData.invitation_type === 'new_tenant'
                        ? 'You\'ve been invited to create a new lab in ' + invitationData.organization_name
                        : 'You\'ve been invited to join ' + invitationData.tenant_name"></p>
                    <p class="mt-1 text-sm text-blue-600">Complete the form below to accept the invitation.</p>
                </div>
            </div>
        </div>
    </template>

    <!-- Progress Steps -->
    <div class="mb-8" x-show="step >= 0">
        <div class="flex items-center justify-center">
            <template x-for="(stepName, index) in stepNames" :key="index">
                <div class="flex items-center">
                    <div class="flex items-center justify-center w-8 h-8 rounded-full text-sm font-medium transition-colors"
                         :class="step > index ? 'bg-primary-600 text-white' : (step === index ? 'bg-primary-100 text-primary-600 ring-2 ring-primary-600' : 'bg-gray-100 text-gray-400')">
                        <span x-show="step <= index" x-text="index + 1"></span>
                        <svg x-show="step > index" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div x-show="index < stepNames.length - 1" class="w-12 h-0.5 mx-2"
                         :class="step > index ? 'bg-primary-600' : 'bg-gray-200'"></div>
                </div>
            </template>
        </div>
        <p class="text-center text-sm text-gray-500 mt-2" x-text="stepNames[step]"></p>
    </div>

    <!-- Messages -->
    <div id="register-message"></div>

    <!-- Step: Account Type (only for non-invitation flow) -->
    <div x-show="isAccountTypeStep" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-x-4" x-transition:enter-end="opacity-100 translate-x-0">
        <div class="bg-white shadow rounded-lg p-6 space-y-4">
            <h3 class="text-lg font-medium text-gray-900">What describes you best?</h3>

            <!-- Invitation notice -->
            <div x-show="inviteToken" class="rounded-md bg-green-50 p-4 mb-4">
                <div class="flex">
                    <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <p class="ml-3 text-sm text-green-700">You have an invitation link! You'll be added to your PI's lab automatically.</p>
                </div>
            </div>

            <div class="space-y-3" x-show="!inviteToken">
                <button @click="form.isPI = true; nextStep()"
                        class="w-full flex items-center p-4 border-2 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-colors"
                        :class="form.isPI ? 'border-primary-500 bg-primary-50' : 'border-gray-200'">
                    <div class="flex-shrink-0 w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                    </div>
                    <div class="ml-4 text-left">
                        <p class="text-sm font-medium text-gray-900">I'm a Principal Investigator / Lab Head</p>
                        <p class="text-sm text-gray-500">I'm setting up a new lab and will manage the team</p>
                    </div>
                </button>

                <button @click="form.isPI = false; nextStep()"
                        class="w-full flex items-center p-4 border-2 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-colors"
                        :class="!form.isPI && form.isPI !== null ? 'border-primary-500 bg-primary-50' : 'border-gray-200'">
                    <div class="flex-shrink-0 w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <div class="ml-4 text-left">
                        <p class="text-sm font-medium text-gray-900">I'm joining an existing lab</p>
                        <p class="text-sm text-gray-500">I'll request to join my PI's lab</p>
                    </div>
                </button>
            </div>

            <div x-show="inviteToken">
                <button @click="form.isPI = false; nextStep()"
                        class="w-full bg-primary-600 text-white rounded-lg px-4 py-3 font-medium hover:bg-primary-500 transition-colors">
                    Continue with invitation
                </button>
            </div>
        </div>
    </div>

    <!-- Step: Account Details -->
    <div x-show="isDetailsStep" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-x-4" x-transition:enter-end="opacity-100 translate-x-0">
        <div class="bg-white shadow rounded-lg p-6 space-y-4">
            <h3 class="text-lg font-medium text-gray-900">Your Details</h3>

            <div>
                <label class="block text-sm font-medium text-gray-700">Full Name</label>
                <input type="text" x-model="form.fullName" required
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Email Address</label>
                <input type="email" x-model="form.email" required
                       :readonly="invitationData !== null"
                       :class="invitationData ? 'bg-gray-100 cursor-not-allowed' : ''"
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                <p x-show="invitationData" class="mt-1 text-xs text-gray-500">Email is set by the invitation and cannot be changed.</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" x-model="form.password" required minlength="8"
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                <p class="mt-1 text-xs text-gray-500">At least 8 characters</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Confirm Password</label>
                <input type="password" x-model="form.passwordConfirm" required
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
            </div>

            <div class="flex gap-3 pt-4">
                <button x-show="step > 0" @click="prevStep()" class="flex-1 border border-gray-300 rounded-lg px-4 py-2 text-gray-700 hover:bg-gray-50">Back</button>
                <button @click="validateStep1() && nextStep()" class="flex-1 bg-primary-600 text-white rounded-lg px-4 py-2 hover:bg-primary-500">Continue</button>
            </div>
        </div>
    </div>

    <!-- Step: Organization (PI) or PI Identifier (Member) -->
    <div x-show="isInstitutionStep" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-x-4" x-transition:enter-end="opacity-100 translate-x-0">
        <div class="bg-white shadow rounded-lg p-6 space-y-4">
            <!-- PI: Institution Selection -->
            <template x-if="form.isPI">
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-900">Your Institution</h3>
                    <p class="text-sm text-gray-500">Search for your university or research institution.</p>

                    <!-- Country Selection -->
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700">Country</label>
                        <input type="text" x-model="countrySearch"
                               @input="filterCountries()"
                               @focus="showCountryDropdown = true"
                               @click.away="showCountryDropdown = false"
                               placeholder="Start typing to search..."
                               autocomplete="off"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">

                        <!-- Country Dropdown -->
                        <div x-show="showCountryDropdown && filteredCountries.length > 0"
                             x-transition
                             class="absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md border border-gray-200 max-h-48 overflow-y-auto">
                            <template x-for="country in filteredCountries.slice(0, 10)" :key="country">
                                <button @click="selectCountry(country)" type="button"
                                        class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 focus:bg-gray-100">
                                    <span x-text="country"></span>
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- Institution Search -->
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700">Institution / University</label>
                        <input type="text" x-model="uniSearch"
                               @input.debounce.300ms="searchUniversities()"
                               @focus="showUniDropdown = true"
                               placeholder="Search universities..."
                               autocomplete="off"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                        <p class="mt-1 text-xs text-gray-500" x-show="form.country">Searching in <span x-text="form.country"></span></p>

                        <!-- Loading indicator -->
                        <div x-show="uniLoading" class="absolute right-3 top-9">
                            <svg class="animate-spin h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>

                        <!-- University Dropdown -->
                        <div x-show="showUniDropdown && uniResults.length > 0"
                             @click.away="showUniDropdown = false"
                             x-transition
                             class="absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md border border-gray-200 max-h-60 overflow-y-auto">
                            <template x-for="uni in uniResults" :key="uni.name">
                                <button @click="selectUniversity(uni)" type="button"
                                        class="w-full px-3 py-2 text-left hover:bg-gray-100 focus:bg-gray-100 border-b border-gray-100 last:border-0">
                                    <p class="text-sm font-medium text-gray-900" x-text="uni.name"></p>
                                    <p class="text-xs text-gray-500" x-text="uni.country"></p>
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- Selected Institution -->
                    <template x-if="form.organization">
                        <div class="bg-green-50 border border-green-200 rounded-md p-3 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-green-800" x-text="form.organization"></p>
                                <p class="text-xs text-green-600" x-text="form.country"></p>
                            </div>
                            <button @click="clearInstitution()" type="button" class="text-green-600 hover:text-green-800">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </template>

                    <!-- Manual Entry Option -->
                    <div class="border-t pt-4" x-show="!form.organization">
                        <p class="text-sm text-gray-500 mb-2">Can't find your institution?</p>
                        <button @click="showManualEntry = !showManualEntry" type="button"
                                class="text-sm text-primary-600 hover:text-primary-800">
                            <span x-text="showManualEntry ? 'Cancel manual entry' : 'Enter manually'"></span>
                        </button>

                        <template x-if="showManualEntry">
                            <div class="mt-3 space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Institution Name</label>
                                    <input type="text" x-model="form.manualOrg"
                                           placeholder="e.g., Imperial College London"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                                </div>
                                <button @click="useManualEntry()" type="button"
                                        class="w-full bg-gray-100 text-gray-700 rounded-md px-3 py-2 text-sm hover:bg-gray-200">
                                    Use this institution
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Member: PI Identifier -->
            <template x-if="!form.isPI && !inviteToken">
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-900">Find Your Lab</h3>
                    <p class="text-sm text-gray-500">Enter your PI's name or email address to request access to their lab.</p>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">PI's Name or Email</label>
                        <input type="text" x-model="form.piIdentifier" required
                               placeholder="e.g., Dr. Jane Smith or jane.smith@example.com"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                    </div>

                    <div class="bg-blue-50 rounded-md p-3">
                        <p class="text-sm text-blue-700">Your PI will need to approve your request before you can access the system.</p>
                    </div>
                </div>
            </template>

            <!-- Member with invitation -->
            <template x-if="!form.isPI && inviteToken">
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-900">Lab Access</h3>
                    <div class="bg-green-50 border border-green-200 rounded-md p-4">
                        <p class="text-sm text-green-800">You'll be automatically added to your PI's lab with your invitation link.</p>
                    </div>
                </div>
            </template>

            <div class="flex gap-3 pt-4">
                <button @click="prevStep()" class="flex-1 border border-gray-300 rounded-lg px-4 py-2 text-gray-700 hover:bg-gray-50">Back</button>
                <button @click="validateStep2() && nextStep()" class="flex-1 bg-primary-600 text-white rounded-lg px-4 py-2 hover:bg-primary-500">Continue</button>
            </div>
        </div>
    </div>

    <!-- Step: Lab Details (PI only) / Confirm -->
    <div x-show="isConfirmStep" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-x-4" x-transition:enter-end="opacity-100 translate-x-0">
        <div class="bg-white shadow rounded-lg p-6 space-y-4">
            <h3 class="text-lg font-medium text-gray-900" x-text="form.isPI ? 'Lab Details' : 'Almost Done'"></h3>

            <template x-if="form.isPI && !invitationData">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Lab Name (optional)</label>
                        <input type="text" x-model="form.labName"
                               :placeholder="getDefaultLabName()"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                        <p class="mt-1 text-xs text-gray-500">Leave blank to use the default name</p>
                    </div>

                    <!-- Summary -->
                    <div class="bg-gray-50 rounded-md p-4 mt-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Summary</h4>
                        <dl class="text-sm space-y-1">
                            <div class="flex justify-between">
                                <dt class="text-gray-500">Institution:</dt>
                                <dd class="text-gray-900" x-text="form.organization"></dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="text-gray-500">Country:</dt>
                                <dd class="text-gray-900" x-text="form.country"></dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </template>

            <!-- New Tenant invitation: lab details -->
            <template x-if="invitationData && invitationData.invitation_type === 'new_tenant'">
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-md p-3">
                        <p class="text-sm text-gray-600">Organization: <strong x-text="invitationData.organization_name"></strong></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Lab Name (optional)</label>
                        <input type="text" x-model="form.labName"
                               :placeholder="form.fullName ? form.fullName + ' Lab' : 'e.g., Smith Lab'"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                        <p class="mt-1 text-xs text-gray-500">Leave blank to use the default name</p>
                    </div>
                </div>
            </template>

            <!-- Terms -->
            <div class="flex items-start pt-4">
                <input type="checkbox" x-model="form.acceptTerms" required
                       class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500 mt-0.5">
                <label class="ml-2 text-sm text-gray-700">
                    I agree to the <a href="/terms" class="text-primary-600 hover:text-primary-500">Terms of Service</a>
                    and <a href="/privacy" class="text-primary-600 hover:text-primary-500">Privacy Policy</a>
                </label>
            </div>

            <div class="flex gap-3 pt-4">
                <button @click="prevStep()" class="flex-1 border border-gray-300 rounded-lg px-4 py-2 text-gray-700 hover:bg-gray-50">Back</button>
                <button @click="submitRegistration()" :disabled="loading || !form.acceptTerms"
                        class="flex-1 bg-primary-600 text-white rounded-lg px-4 py-2 hover:bg-primary-500 disabled:opacity-50 flex items-center justify-center">
                    <svg x-show="loading" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span x-text="loading ? 'Creating account...' : 'Create Account'"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Countries list
const COUNTRIES = [
    "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Argentina", "Armenia", "Australia",
    "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium",
    "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei",
    "Bulgaria", "Burkina Faso", "Burundi", "Cambodia", "Cameroon", "Canada", "Cape Verde",
    "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo", "Costa Rica",
    "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark", "Djibouti", "Dominican Republic",
    "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia",
    "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada",
    "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Honduras", "Hungary", "Iceland", "India",
    "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Ivory Coast", "Jamaica", "Japan", "Jordan",
    "Kazakhstan", "Kenya", "Kiribati", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho",
    "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia",
    "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico", "Micronesia",
    "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru",
    "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia",
    "Norway", "Oman", "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru",
    "Philippines", "Poland", "Portugal", "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis",
    "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Saudi Arabia", "Senegal",
    "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia",
    "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden",
    "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Timor-Leste", "Togo", "Tonga",
    "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu", "Uganda", "Ukraine",
    "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan", "Vanuatu",
    "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"
];

function registrationWizard(inviteToken, invitationData) {
    return {
        step: 0,
        inviteToken: inviteToken,
        invitationData: invitationData,
        loading: false,

        // Dynamic step names based on flow
        get stepNames() {
            if (this.invitationData) {
                if (this.invitationData.invitation_type === 'lab_member') {
                    return ['Your Details', 'Confirm'];
                } else {
                    // NEW_TENANT: need lab details
                    return ['Your Details', 'Lab Details', 'Confirm'];
                }
            }
            return ['Account Type', 'Your Details', 'Institution', 'Confirm'];
        },

        // Country autocomplete
        countrySearch: '',
        filteredCountries: [],
        showCountryDropdown: false,

        // University autocomplete
        uniSearch: '',
        uniResults: [],
        uniLoading: false,
        showUniDropdown: false,

        // Manual entry
        showManualEntry: false,

        form: {
            isPI: null,
            fullName: '',
            email: '',
            password: '',
            passwordConfirm: '',
            organization: '',
            country: '',
            piIdentifier: '',
            labName: '',
            manualOrg: '',
            acceptTerms: false
        },

        init() {
            // Pre-fill from invitation data
            if (this.invitationData) {
                this.form.email = this.invitationData.email;
                if (this.invitationData.invitation_type === 'lab_member') {
                    this.form.isPI = false;
                } else {
                    this.form.isPI = true;
                    if (this.invitationData.organization_name) {
                        this.form.organization = this.invitationData.organization_name;
                    }
                }
            }
        },

        get maxStep() {
            return this.stepNames.length - 1;
        },

        // Map logical step to actual display step for invitation flows
        get isConfirmStep() {
            return this.step === this.maxStep;
        },

        get isDetailsStep() {
            if (this.invitationData) return this.step === 0;
            return this.step === 1;
        },

        get isInstitutionStep() {
            if (this.invitationData && this.invitationData.invitation_type === 'new_tenant') {
                return this.step === 1;
            }
            if (!this.invitationData) return this.step === 2;
            return false;
        },

        get isAccountTypeStep() {
            return !this.invitationData && this.step === 0;
        },

        nextStep() {
            if (this.step < this.maxStep) this.step++;
        },

        prevStep() {
            if (this.step > 0) this.step--;
        },

        filterCountries() {
            if (this.countrySearch.length < 1) {
                this.filteredCountries = COUNTRIES.slice(0, 10);
            } else {
                const search = this.countrySearch.toLowerCase();
                this.filteredCountries = COUNTRIES.filter(c =>
                    c.toLowerCase().includes(search)
                );
            }
            this.showCountryDropdown = true;
        },

        selectCountry(country) {
            this.form.country = country;
            this.countrySearch = country;
            this.showCountryDropdown = false;
            // Clear university if country changed
            if (this.form.organization) {
                this.uniSearch = '';
                this.form.organization = '';
            }
        },

        async searchUniversities() {
            if (this.uniSearch.length < 2) {
                this.uniResults = [];
                return;
            }

            this.uniLoading = true;
            this.showUniDropdown = true;

            try {
                // Use backend proxy to avoid CORS issues
                let url = `/api/organizations/universities/search?q=${encodeURIComponent(this.uniSearch)}`;
                if (this.form.country) {
                    url += `&country=${encodeURIComponent(this.form.country)}`;
                }

                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    this.uniResults = data.slice(0, 15);
                }
            } catch (error) {
                console.error('Error searching universities:', error);
                this.uniResults = [];
            } finally {
                this.uniLoading = false;
            }
        },

        selectUniversity(uni) {
            this.form.organization = uni.name;
            this.form.country = uni.country;
            this.countrySearch = uni.country;
            this.uniSearch = uni.name;
            this.showUniDropdown = false;
            this.showManualEntry = false;
        },

        clearInstitution() {
            this.form.organization = '';
            this.uniSearch = '';
        },

        useManualEntry() {
            if (this.form.manualOrg) {
                this.form.organization = this.form.manualOrg;
                this.uniSearch = this.form.manualOrg;
                this.showManualEntry = false;
            }
        },

        getDefaultLabName() {
            if (this.form.organization && this.form.fullName) {
                return this.form.organization + ' - ' + this.form.fullName + ' Lab';
            }
            return 'e.g., Smith Lab';
        },

        validateStep1() {
            const messageDiv = document.getElementById('register-message');
            if (!this.form.fullName || !this.form.email || !this.form.password) {
                messageDiv.innerHTML = '<div class="mb-4 rounded-md bg-red-50 p-4"><p class="text-sm text-red-700">Please fill in all fields.</p></div>';
                return false;
            }
            if (this.form.password !== this.form.passwordConfirm) {
                messageDiv.innerHTML = '<div class="mb-4 rounded-md bg-red-50 p-4"><p class="text-sm text-red-700">Passwords do not match.</p></div>';
                return false;
            }
            if (this.form.password.length < 8) {
                messageDiv.innerHTML = '<div class="mb-4 rounded-md bg-red-50 p-4"><p class="text-sm text-red-700">Password must be at least 8 characters.</p></div>';
                return false;
            }
            messageDiv.innerHTML = '';
            return true;
        },

        validateStep2() {
            const messageDiv = document.getElementById('register-message');
            if (this.form.isPI) {
                if (!this.form.organization) {
                    messageDiv.innerHTML = '<div class="mb-4 rounded-md bg-red-50 p-4"><p class="text-sm text-red-700">Please select or enter your institution.</p></div>';
                    return false;
                }
                if (!this.form.country) {
                    messageDiv.innerHTML = '<div class="mb-4 rounded-md bg-red-50 p-4"><p class="text-sm text-red-700">Please select your country.</p></div>';
                    return false;
                }
            } else if (!this.inviteToken && !this.form.piIdentifier) {
                messageDiv.innerHTML = '<div class="mb-4 rounded-md bg-red-50 p-4"><p class="text-sm text-red-700">Please enter your PI\'s name or email.</p></div>';
                return false;
            }
            messageDiv.innerHTML = '';
            return true;
        },

        async submitRegistration() {
            this.loading = true;
            const messageDiv = document.getElementById('register-message');

            const data = {
                full_name: this.form.fullName,
                email: this.form.email,
                password: this.form.password,
                password_confirm: this.form.passwordConfirm,
                is_pi: this.form.isPI,
                invitation_token: (this.invitationData ? this.invitationData.token : null) || this.inviteToken || null
            };

            if (this.invitationData && this.invitationData.invitation_type === 'new_tenant') {
                data.is_pi = true;
                data.organization = this.invitationData.organization_name;
                if (this.form.labName) data.lab_name = this.form.labName;
                if (this.form.country) data.country = this.form.country;
            } else if (this.invitationData) {
                // lab_member invitation - no extra fields needed
            } else if (this.form.isPI) {
                data.organization = this.form.organization;
                if (this.form.labName) data.lab_name = this.form.labName;
                if (this.form.country) data.country = this.form.country;
            } else if (!this.inviteToken) {
                data.pi_identifier = this.form.piIdentifier;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    // Registration successful - show verification email message
                    let icon, bgColor, textColor, title;
                    if (result.pending_approval) {
                        icon = `<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />`;
                        bgColor = 'bg-yellow-50';
                        textColor = 'text-yellow-400';
                        title = 'Almost There!';
                    } else {
                        icon = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />`;
                        bgColor = 'bg-green-50';
                        textColor = 'text-green-400';
                        title = 'Check Your Email!';
                    }
                    messageDiv.innerHTML = `
                        <div class="rounded-md ${bgColor} p-4">
                            <div class="flex">
                                <svg class="h-5 w-5 ${textColor}" viewBox="0 0 20 20" fill="currentColor">
                                    ${icon}
                                </svg>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-gray-800">${title}</h3>
                                    <p class="mt-2 text-sm text-gray-700">${result.message}</p>
                                    <p class="mt-2 text-sm text-gray-600">
                                        <a href="/login" class="font-medium text-primary-600 hover:text-primary-500">Go to Login</a>
                                    </p>
                                </div>
                            </div>
                        </div>`;
                    // Hide the form
                    this.step = -1;
                } else {
                    let errorMsg = result.detail;
                    if (Array.isArray(errorMsg)) {
                        errorMsg = errorMsg.map(e => e.msg || e.message || e).join(', ');
                    }
                    messageDiv.innerHTML = `
                        <div class="rounded-md bg-red-50 p-4">
                            <p class="text-sm text-red-700">${errorMsg || 'Registration failed'}</p>
                        </div>`;
                }
            } catch (error) {
                console.error('Registration error:', error);
                messageDiv.innerHTML = `
                    <div class="rounded-md bg-red-50 p-4">
                        <p class="text-sm text-red-700">An error occurred. Please try again.</p>
                    </div>`;
            } finally {
                this.loading = false;
            }
        }
    }
}
</script>
{% endblock %}
