{% extends "base.html" %}

{% block content %}
<div class="mb-6 flex items-center justify-between">
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2">
            <li><a href="/stocks" class="text-gray-500 hover:text-gray-700">Stocks</a></li>
            <li class="flex items-center">
                <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
                <span class="ml-2 text-gray-900 font-medium">Stock Details</span>
            </li>
        </ol>
    </nav>
    <div id="stock-nav" x-data="stockNav()" x-init="init()" class="flex items-center gap-2">
        <a x-show="prevStock" :href="getNavUrl(prevStock.prev_id)"
           @click.prevent="navigateTo(prevStock.prev_id)"
           class="inline-flex items-center gap-1 rounded-md bg-white px-2.5 py-1.5 text-sm font-medium text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
           :title="'Previous: ' + (prevStock?.prev_stock_id || '')">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
            <span class="hidden sm:inline text-xs" x-text="prevStock?.prev_stock_id"></span>
        </a>
        <a x-show="nextStock" :href="getNavUrl(nextStock.next_id)"
           @click.prevent="navigateTo(nextStock.next_id)"
           class="inline-flex items-center gap-1 rounded-md bg-white px-2.5 py-1.5 text-sm font-medium text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
           :title="'Next: ' + (nextStock?.next_stock_id || '')">
            <span class="hidden sm:inline text-xs" x-text="nextStock?.next_stock_id"></span>
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
            </svg>
        </a>
    </div>
</div>

<div id="stock-content" x-data="stockDetail()" x-init="init()">
    <!-- Loading state -->
    <template x-if="loading">
        <div class="animate-pulse bg-white shadow rounded-lg p-6">
            <div class="h-6 bg-gray-200 rounded w-1/4 mb-4"></div>
            <div class="space-y-3">
                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                <div class="h-4 bg-gray-200 rounded w-2/3"></div>
            </div>
        </div>
    </template>

    <!-- Error state -->
    <template x-if="!loading && error">
        <div class="bg-white shadow rounded-lg p-6 text-center">
            <svg class="mx-auto h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <h3 class="mt-2 text-sm font-semibold text-gray-900">Stock not found</h3>
            <div class="mt-6">
                <a href="/stocks" class="text-primary-600 hover:text-primary-500">Back to stocks</a>
            </div>
        </div>
    </template>

    <!-- Stock details -->
    <template x-if="!loading && !error && stock">
        <div class="space-y-6">
            <!-- Dead Stock Banner -->
            <div x-show="!stock.is_active" class="rounded-lg bg-red-50 border border-red-200 p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <svg class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                    </svg>
                    <span class="text-sm font-medium text-red-800">This stock is marked as dead.</span>
                </div>
                <button @click="restoreStock()"
                        class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-red-700 shadow-sm ring-1 ring-inset ring-red-300 hover:bg-red-50">
                    Restore Stock
                </button>
            </div>

            <!-- Large Touch-Friendly Print Button -->
            <button x-show="!editing && stock.is_active" @click="printLabel()" :disabled="printing"
                    :class="{
                        'bg-emerald-200 text-emerald-900 ring-emerald-400': printSuccess,
                        'bg-emerald-100 hover:bg-emerald-200 text-emerald-800 ring-emerald-300': !printSuccess && hasOnlineAgent,
                        'bg-slate-100 hover:bg-slate-200 text-slate-700 ring-slate-300': !printSuccess && !hasOnlineAgent
                    }"
                    class="w-full flex items-center justify-center gap-3 rounded-xl px-6 py-5 text-lg font-semibold shadow-sm ring-1 ring-inset disabled:opacity-50 active:scale-[0.98] transition-all duration-200 touch-manipulation">
                <svg class="h-7 w-7" :class="{'animate-spin': printing}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <template x-if="printSuccess">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </template>
                    <template x-if="printing && !printSuccess">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </template>
                    <template x-if="!printing && !printSuccess">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </template>
                </svg>
                <span x-text="printSuccess ? 'Sent!' : (printing ? 'Printing...' : 'Flip Stock & Print Label')"></span>
            </button>

            <!-- Header -->
            <div class="bg-white shadow rounded-lg p-5">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div class="flex items-center gap-3">
                            <h1 class="text-2xl font-semibold text-gray-900" x-text="stock.stock_id"></h1>
                            <!-- Flip Status Badge -->
                            <span x-show="flipStatus"
                                  class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs font-medium"
                                  :class="getFlipStatusBadgeClass(flipStatus?.flip_status)">
                                <span class="h-2 w-2 rounded-full" :class="getFlipStatusDotClass(flipStatus?.flip_status)"></span>
                                <span x-text="getFlipStatusLabel(flipStatus?.flip_status, flipStatus?.days_since_flip)"></span>
                            </span>
                        </div>
                        <div class="mt-1 flex items-center space-x-2">
                            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium"
                                  :class="getOriginBadgeClass(stock.origin)"
                                  x-text="getOriginLabel(stock.origin)"></span>
                            <span x-show="stock.repository" class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800"
                                  x-text="stock.repository?.toUpperCase()"></span>
                            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium"
                                  :class="getVisibilityBadgeClass(stock.visibility)"
                                  x-text="getVisibilityLabel(stock.visibility)"></span>
                        </div>
                    </div>
                    <div class="flex space-x-3" x-show="stock.is_active">
                        <button @click="if (editing) { resetForm(); } editing = !editing"
                                class="inline-flex items-center rounded-md bg-amber-50 px-3 py-2 text-sm font-semibold text-amber-700 shadow-sm ring-1 ring-inset ring-amber-200 hover:bg-amber-100">
                            <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            <span x-text="editing ? 'Cancel' : 'Edit'"></span>
                        </button>
                        <button x-show="editing" @click="saveStock()" :disabled="saving"
                                class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 disabled:opacity-50">
                            <span x-show="!saving">Save Changes</span>
                            <span x-show="saving">Saving...</span>
                        </button>
                        <button x-show="!editing" @click="markAsDead()" class="inline-flex items-center rounded-md bg-rose-50 px-3 py-2 text-sm font-semibold text-rose-700 shadow-sm ring-1 ring-inset ring-rose-200 hover:bg-rose-100">
                            <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            Mark as Dead
                        </button>
                    </div>
                </div>

                <!-- View Mode -->
                <div x-show="!editing">
                    <!-- Shortname (human-readable summary) -->
                    <div class="mb-3" x-show="stock.shortname">
                        <dd class="text-sm font-medium text-gray-600 italic" x-text="stock.shortname"></dd>
                    </div>

                    <!-- Genotype -->
                    <div class="mb-3">
                        <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide">Genotype</dt>
                        <dd class="mt-1 text-sm text-gray-900 font-mono bg-gray-50 px-3 py-2 rounded" x-text="stock.genotype"></dd>
                    </div>

                    <!-- Original Genotype (if different) -->
                    <div class="mb-3" x-show="stock.original_genotype && stock.original_genotype !== stock.genotype">
                        <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide">Original Genotype (from repository)</dt>
                        <dd class="mt-1 text-sm text-gray-500 font-mono bg-gray-50 px-3 py-2 rounded" x-text="stock.original_genotype"></dd>
                    </div>

                    <!-- Tags (inline, right after genotype) -->
                    <div class="mb-4 flex flex-wrap gap-1.5" x-show="stock.tags && stock.tags.length > 0">
                        <template x-for="tag in stock.tags" :key="tag.id">
                            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium"
                                  :style="{ backgroundColor: (tag.color || '#6b7280') + '20', color: tag.color || '#6b7280' }"
                                  x-text="tag.name"></span>
                        </template>
                    </div>

                    <!-- Compact property grid -->
                    <dl class="grid grid-cols-2 sm:grid-cols-4 gap-x-4 gap-y-2.5 mb-4">
                        <div>
                            <dt class="text-xs text-gray-500">Origin</dt>
                            <dd class="text-sm text-gray-900" x-text="getOriginLabel(stock.origin)"></dd>
                        </div>
                        <div x-show="stock.origin === 'repository'">
                            <dt class="text-xs text-gray-500">Repository</dt>
                            <dd class="text-sm text-gray-900">
                                <span x-text="stock.repository?.toUpperCase() || '-'"></span>
                                <span x-show="stock.repository_stock_id" class="text-gray-500">#<span x-text="stock.repository_stock_id"></span></span>
                                <template x-if="stock.repository_stock_id">
                                    <span class="inline-flex gap-1.5 ml-1.5">
                                        <a :href="getStockCenterUrl(stock.repository, stock.repository_stock_id)"
                                           target="_blank" rel="noopener"
                                           class="text-blue-600 hover:text-blue-800 text-xs font-medium"
                                           x-text="stock.repository?.toUpperCase()"></a>
                                        <a :href="'https://flybase.org/search/' + stock.repository?.toUpperCase() + ':' + stock.repository_stock_id"
                                           target="_blank" rel="noopener"
                                           class="text-blue-600 hover:text-blue-800 text-xs font-medium">FlyBase</a>
                                    </span>
                                </template>
                            </dd>
                        </div>
                        <div x-show="stock.origin === 'external'">
                            <dt class="text-xs text-gray-500">Source</dt>
                            <dd class="text-sm text-gray-900" x-text="stock.external_source || '-'"></dd>
                        </div>
                        <div>
                            <dt class="text-xs text-gray-500">Tray</dt>
                            <dd class="text-sm text-gray-900" x-text="stock.tray?.name || 'Not assigned'"></dd>
                        </div>
                        <div>
                            <dt class="text-xs text-gray-500">Position</dt>
                            <dd class="text-sm text-gray-900" x-text="stock.position || '-'"></dd>
                        </div>
                        <div>
                            <dt class="text-xs text-gray-500">Owner</dt>
                            <dd class="text-sm text-gray-900" x-text="stock.owner?.full_name || 'Not assigned'"></dd>
                        </div>
                        <div>
                            <dt class="text-xs text-gray-500">Visibility</dt>
                            <dd class="text-sm text-gray-900" x-text="getVisibilityLabel(stock.visibility)"></dd>
                        </div>
                        <div x-show="stock.shared_with_tenant_ids && stock.shared_with_tenant_ids.length > 0">
                            <dt class="text-xs text-gray-500">Sharing</dt>
                            <dd>
                                <span class="inline-flex items-center rounded-full bg-indigo-100 px-2.5 py-0.5 text-xs font-medium text-indigo-800"
                                      x-text="'Shared with ' + (stock.shared_with_tenant_ids?.length || 0) + ' collaborator(s)'"></span>
                            </dd>
                        </div>
                    </dl>

                    <!-- Notes (only shown when present) -->
                    <div class="mb-4" x-show="stock.notes">
                        <dt class="text-xs text-gray-500">Notes</dt>
                        <dd class="mt-0.5 text-sm text-gray-900 whitespace-pre-wrap" x-text="stock.notes"></dd>
                    </div>

                    <!-- Metadata - compact inline -->
                    <div class="text-xs text-gray-400 flex flex-wrap gap-x-4 gap-y-1 mb-4">
                        <span>Created <span x-text="formatDate(stock.created_at)"></span><span x-show="stock.created_by_name"> by <span x-text="stock.created_by_name"></span></span></span>
                        <span>Modified <span x-text="formatDate(stock.modified_at)"></span><span x-show="stock.modified_by_name"> by <span x-text="stock.modified_by_name"></span></span></span>
                    </div>

                    <!-- Flip History (collapsible) -->
                    <div class="pt-3 border-t border-gray-200" x-data="{ showFlipHistory: false }">
                        <button @click="showFlipHistory = !showFlipHistory" class="flex items-center gap-1 text-xs font-medium text-gray-500 uppercase tracking-wide hover:text-gray-700">
                            <svg class="h-3.5 w-3.5 transition-transform" :class="{ 'rotate-90': showFlipHistory }" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                            Flip History
                            <span class="normal-case font-normal" x-show="flipHistory.length > 0" x-text="'(' + flipHistory.length + ')'"></span>
                        </button>
                        <div x-show="showFlipHistory" x-transition.opacity>
                            <template x-if="flipHistory.length > 0">
                                <div class="space-y-1 mt-2">
                                    <template x-for="flip in flipHistory" :key="flip.id">
                                        <div class="flex items-center justify-between text-sm py-1.5 border-b border-gray-100 last:border-0">
                                            <div class="flex items-center gap-2">
                                                <span class="h-1.5 w-1.5 rounded-full bg-green-500"></span>
                                                <span class="text-gray-900" x-text="formatDate(flip.flipped_at)"></span>
                                                <span class="text-gray-500 text-xs" x-show="flip.flipped_by_name">by <span x-text="flip.flipped_by_name"></span></span>
                                            </div>
                                            <span class="text-gray-400 text-xs" x-show="flip.notes" x-text="flip.notes"></span>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            <p x-show="flipHistory.length === 0" class="text-sm text-gray-500 mt-2">No flip history yet.</p>
                        </div>
                    </div>
                </div>

                <!-- Edit Mode -->
                <div x-show="editing" x-cloak>
                    <form @submit.prevent="saveStock()" class="space-y-6">
                        <!-- Stock ID -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Stock ID</label>
                            <input type="text" x-model="editForm.stock_id" required
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                        </div>

                        <!-- Genotype -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Genotype</label>
                            <textarea x-model="editForm.genotype" rows="3" required
                                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm font-mono"></textarea>
                        </div>

                        <!-- Shortname -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Short Name</label>
                            <div class="mt-1 flex gap-2">
                                <input type="text" x-model="editForm.shortname" placeholder="e.g., GFP membrane marker"
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                <button type="button" @click="suggestShortname()"
                                        :disabled="suggestingShortname || !editForm.genotype"
                                        class="inline-flex items-center whitespace-nowrap rounded-md bg-indigo-50 px-3 py-2 text-sm font-medium text-indigo-700 ring-1 ring-inset ring-indigo-200 hover:bg-indigo-100 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span x-show="!suggestingShortname">Suggest</span>
                                    <span x-show="suggestingShortname">...</span>
                                </button>
                            </div>
                            <p class="mt-1 text-xs text-gray-500">Short human-readable phenotype summary (2-5 words)</p>
                        </div>

                        <!-- Origin -->
                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Origin</label>
                                <select x-model="editForm.origin"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                    <option value="internal">Internal (Lab-created)</option>
                                    <option value="repository">Repository (Stock center)</option>
                                    <option value="external">External (Other lab)</option>
                                </select>
                            </div>
                            <div x-show="editForm.origin === 'repository'">
                                <label class="block text-sm font-medium text-gray-700">Repository</label>
                                <select x-model="editForm.repository"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                    <option value="">Select...</option>
                                    <option value="bdsc">BDSC (Bloomington)</option>
                                    <option value="vdrc">VDRC (Vienna)</option>
                                    <option value="kyoto">Kyoto DGRC</option>
                                    <option value="nig">NIG-Fly (Japan)</option>
                                    <option value="dgrc">DGRC (Indiana)</option>
                                    <option value="flyorf">FlyORF (Zurich)</option>
                                    <option value="trip">TRiP (Harvard)</option>
                                    <option value="exelixis">Exelixis (Harvard)</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div x-show="editForm.origin === 'repository'">
                                <label class="block text-sm font-medium text-gray-700">Repository Stock ID</label>
                                <input type="text" x-model="editForm.repository_stock_id" placeholder="e.g., 3605"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                            </div>
                            <div x-show="editForm.origin === 'external'" class="sm:col-span-2">
                                <label class="block text-sm font-medium text-gray-700">External Source</label>
                                <input type="text" x-model="editForm.external_source" placeholder="Lab or researcher name"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                            </div>
                        </div>

                        <!-- Tags (badge toggles) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="tag in allTags" :key="tag.id">
                                    <button type="button"
                                            @click="editForm.tag_ids.includes(tag.id) ? editForm.tag_ids = editForm.tag_ids.filter(id => id !== tag.id) : editForm.tag_ids.push(tag.id)"
                                            class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium cursor-pointer transition-all duration-150 ring-1 ring-inset"
                                            :style="editForm.tag_ids.includes(tag.id)
                                                ? { backgroundColor: (tag.color || '#6b7280'), color: '#fff', '--tw-ring-color': (tag.color || '#6b7280') }
                                                : { backgroundColor: (tag.color || '#6b7280') + '15', color: (tag.color || '#6b7280'), '--tw-ring-color': (tag.color || '#6b7280') + '40' }"
                                            x-text="tag.name">
                                    </button>
                                </template>
                                <!-- Add new tag button -->
                                <button type="button" x-show="!showNewTagForm"
                                        @click="showNewTagForm = true"
                                        class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium text-gray-500 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 cursor-pointer">
                                    + New Tag
                                </button>
                            </div>
                            <!-- Inline new tag form -->
                            <div x-show="showNewTagForm" x-transition class="mt-2 flex items-center gap-2">
                                <input type="text" x-model="newTagName" placeholder="Tag name"
                                       class="block w-32 rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm py-1">
                                <input type="color" x-model="newTagColor"
                                       class="h-8 w-8 rounded border-gray-300 cursor-pointer">
                                <button type="button" @click="createTag()" :disabled="!newTagName.trim()"
                                        class="inline-flex items-center rounded-md bg-primary-600 px-2.5 py-1 text-xs font-semibold text-white shadow-sm hover:bg-primary-500 disabled:opacity-50">
                                    Add
                                </button>
                                <button type="button" @click="showNewTagForm = false; newTagName = ''; newTagColor = '#6b7280'"
                                        class="inline-flex items-center rounded-md px-2.5 py-1 text-xs font-medium text-gray-600 hover:text-gray-800">
                                    Cancel
                                </button>
                            </div>
                            <p x-show="allTags.length === 0 && !showNewTagForm" class="text-sm text-gray-500">No tags yet. Click "+ New Tag" to create one.</p>
                        </div>

                        <!-- FlyBase metadata fetch -->
                        <div x-show="editForm.origin === 'repository' && editForm.repository && editForm.repository_stock_id"
                             class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-blue-800">
                                        <span x-show="stock.original_genotype && !repositoryGenotype" class="text-green-700">
                                            Already fetched from FlyBase
                                        </span>
                                        <span x-show="!stock.original_genotype && !fetchingMetadata && !repositoryGenotype">
                                            Fetch genotype from FlyBase?
                                        </span>
                                        <span x-show="fetchingMetadata">
                                            Fetching from FlyBase...
                                        </span>
                                        <span x-show="repositoryGenotype && repositoryGenotype !== editForm.genotype" class="font-medium">
                                            FlyBase genotype differs from current genotype
                                        </span>
                                        <span x-show="repositoryGenotype && repositoryGenotype === editForm.genotype" class="text-green-700">
                                            Genotype matches FlyBase
                                        </span>
                                    </p>
                                </div>
                                <button type="button" @click="fetchRepositoryMetadata()"
                                        :disabled="fetchingMetadata"
                                        x-show="!repositoryGenotype"
                                        class="inline-flex items-center rounded-md bg-blue-600 px-3 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 disabled:opacity-50">
                                    <span x-show="!fetchingMetadata">Fetch</span>
                                    <span x-show="fetchingMetadata">...</span>
                                </button>
                            </div>
                            <!-- Show genotype comparison when fetched and different -->
                            <div x-show="repositoryGenotype && repositoryGenotype !== editForm.genotype" class="mt-3 space-y-2">
                                <div>
                                    <p class="text-xs font-medium text-gray-500 mb-1">Current genotype:</p>
                                    <p class="text-xs font-mono bg-white p-2 rounded border" x-text="editForm.genotype"></p>
                                </div>
                                <div>
                                    <p class="text-xs font-medium text-gray-500 mb-1">FlyBase genotype:</p>
                                    <p class="text-xs font-mono bg-white p-2 rounded border text-blue-800" x-text="repositoryGenotype"></p>
                                </div>
                                <div class="flex gap-2 pt-2">
                                    <button type="button" @click="useRepositoryGenotype()"
                                            class="inline-flex items-center rounded-md bg-blue-600 px-3 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-500">
                                        Use FlyBase genotype
                                    </button>
                                    <button type="button" @click="keepCurrentGenotype()"
                                            class="inline-flex items-center rounded-md bg-white px-3 py-1.5 text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                                        Keep current
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Original Genotype -->
                        <div x-show="editForm.origin === 'repository'">
                            <label class="block text-sm font-medium text-gray-700">Original Genotype (from repository)</label>
                            <textarea x-model="editForm.original_genotype" rows="2"
                                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm font-mono"></textarea>
                            <p class="mt-1 text-xs text-gray-500">Leave blank if genotype hasn't been modified from original</p>
                        </div>

                        <!-- Physical Location -->
                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tray</label>
                                <select x-model="editForm.tray_id"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                    <option value="">Not assigned</option>
                                    <template x-for="tray in trays" :key="tray.id">
                                        <option :value="tray.id" x-text="tray.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Position</label>
                                <input type="text" x-model="editForm.position" placeholder="e.g., A1 or 42"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                            </div>
                        </div>

                        <!-- Owner & Visibility -->
                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Owner</label>
                                <select x-model="editForm.owner_id"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                    <option value="">Not assigned</option>
                                    <template x-for="user in users" :key="user.id">
                                        <option :value="user.id" x-text="user.full_name"></option>
                                    </template>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Visibility</label>
                                <select x-model="editForm.visibility"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                    <option value="lab_only">Lab Only</option>
                                    <option value="organization">Organization</option>
                                    <option value="public">Public</option>
                                </select>
                            </div>
                        </div>

                        <!-- Share with Collaborators -->
                        <template x-if="collaborators.length > 0">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Share with Collaborators</label>
                                <div class="border border-gray-200 rounded-md p-3 space-y-2 max-h-40 overflow-y-auto">
                                    <template x-for="collab in collaborators" :key="collab.collaborator.id">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" :value="collab.collaborator.id"
                                                   x-model="editForm.shared_with_tenant_ids"
                                                   class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                            <span class="text-sm text-gray-700" x-text="collab.collaborator.admin_name || collab.collaborator.name"></span>
                                            <span class="text-xs text-gray-400" x-text="collab.collaborator.name"></span>
                                        </label>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <!-- Notes -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Notes</label>
                            <textarea x-model="editForm.notes" rows="3"
                                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"></textarea>
                        </div>


                    </form>
                </div>
            </div>
        </div>
    </template>
</div>

<script>
function stockNav() {
    return {
        prevStock: null,
        nextStock: null,
        navParams: '',

        init() {
            this.navParams = window.location.search.replace('?', '');
            this.loadAdjacentStocks();

            // Keyboard navigation (left/right arrows)
            document.addEventListener('keydown', (e) => {
                // Skip if user is typing in an input/textarea/select
                const tag = e.target.tagName;
                if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
                if (e.target.isContentEditable) return;

                if (e.key === 'ArrowLeft' && this.prevStock) {
                    e.preventDefault();
                    this.navigateTo(this.prevStock.prev_id);
                } else if (e.key === 'ArrowRight' && this.nextStock) {
                    e.preventDefault();
                    this.navigateTo(this.nextStock.next_id);
                }
            });
        },

        async loadAdjacentStocks() {
            try {
                const qs = this.navParams ? '?' + this.navParams : '';
                const response = await fetch('/api/stocks/{{ stock_id }}/adjacent' + qs, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    this.prevStock = data.prev_id ? data : null;
                    this.nextStock = data.next_id ? data : null;
                }
            } catch (error) {
                console.error('Error loading adjacent stocks:', error);
            }
        },

        getNavUrl(stockId) {
            const qs = this.navParams ? '?' + this.navParams : '';
            return '/stocks/' + stockId + qs;
        },

        navigateTo(stockId) {
            window.location.href = this.getNavUrl(stockId);
        }
    }
}

function stockDetail() {
    return {
        loading: true,
        error: false,
        editing: false,
        saving: false,
        stock: null,
        trays: [],
        users: [],
        allTags: [],
        fetchingMetadata: false,
        repositoryGenotype: null,
        repositoryMetadata: null,
        suggestingShortname: false,
        // New tag inline form state
        showNewTagForm: false,
        newTagName: '',
        newTagColor: '#6b7280',
        // Print state
        hasOnlineAgent: false,
        printing: false,
        printSuccess: false,
        labelSettings: null,
        // Flip tracking state
        flipStatus: null,
        flipHistory: [],
        // Collaborators
        collaborators: [],
        editForm: {
            stock_id: '',
            genotype: '',
            shortname: '',
            origin: 'internal',
            repository: '',
            repository_stock_id: '',
            external_source: '',
            original_genotype: '',
            tray_id: '',
            position: '',
            owner_id: '',
            visibility: 'lab_only',
            notes: '',
            tag_ids: [],
            shared_with_tenant_ids: []
        },

        async init() {
            await Promise.all([
                this.loadStock(),
                this.loadTrays(),
                this.loadUsers(),
                this.loadTags(),
                this.checkAgentStatus(),
                this.loadLabelSettings(),
                this.loadFlipStatus(),
                this.loadFlipHistory(),
                this.loadCollaborators()
            ]);

            // Watch for repository changes to reset fetched metadata
            this.$watch('editForm.repository', () => this.clearRepositoryMetadata());
            this.$watch('editForm.repository_stock_id', () => this.clearRepositoryMetadata());
        },

        async checkAgentStatus() {
            try {
                const response = await fetch('/api/labels/agents/status/online', {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    this.hasOnlineAgent = data.has_online_agent;
                }
            } catch (error) {
                console.error('Error checking agent status:', error);
            }
        },

        async loadLabelSettings() {
            try {
                const response = await fetch('/api/organizations/tenant/label-settings', {
                    credentials: 'include'
                });
                if (response.ok) {
                    this.labelSettings = await response.json();
                }
            } catch (error) {
                console.error('Error loading label settings:', error);
            }
        },

        async printLabel() {
            if (!this.stock) return;

            this.printing = true;
            this.printSuccess = false;
            const format = this.labelSettings?.default_label_format || 'dymo_11352';
            const codeType = this.labelSettings?.default_code_type || 'qr';

            try {
                if (this.hasOnlineAgent) {
                    // Create a print job for the agent - always 1 copy for single stock
                    // Also record flip event
                    const response = await fetch('/api/labels/print', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            stock_ids: [this.stock.id],
                            label_format: format,
                            copies: 1,
                            code_type: codeType,
                            record_flip: true
                        })
                    });

                    if (response.ok) {
                        // Brief visual success feedback
                        this.printSuccess = true;
                        // Reload flip status to show updated info
                        await this.loadFlipStatus();
                        setTimeout(() => this.printSuccess = false, 2000);
                    } else {
                        throw new Error('Failed to create print job');
                    }
                } else {
                    // No agent - record flip manually then open PDF
                    await this.recordFlip();
                    window.open(`/api/labels/stock/${this.stock.id}/pdf?format=${format}&code_type=${codeType}`, '_blank');
                }
            } catch (error) {
                console.error('Error printing label:', error);
            } finally {
                this.printing = false;
            }
        },

        clearRepositoryMetadata() {
            this.repositoryGenotype = null;
            this.repositoryMetadata = null;
        },

        async loadFlipStatus() {
            try {
                const response = await fetch(`/api/flips/stock/{{ stock_id }}/status`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    this.flipStatus = await response.json();
                }
            } catch (error) {
                console.error('Error loading flip status:', error);
            }
        },

        async loadFlipHistory() {
            try {
                const response = await fetch(`/api/flips/stock/{{ stock_id }}/history?limit=5`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    this.flipHistory = await response.json();
                }
            } catch (error) {
                console.error('Error loading flip history:', error);
            }
        },

        async recordFlip() {
            try {
                const response = await fetch('/api/flips/record', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ stock_id: this.stock.id })
                });
                if (response.ok) {
                    await Promise.all([this.loadFlipStatus(), this.loadFlipHistory()]);
                }
            } catch (error) {
                console.error('Error recording flip:', error);
            }
        },

        getFlipStatusBadgeClass(status) {
            const classes = {
                'ok': 'bg-green-100 text-green-800',
                'warning': 'bg-yellow-100 text-yellow-800',
                'critical': 'bg-red-100 text-red-800',
                'never': 'bg-gray-100 text-gray-600'
            };
            return classes[status] || 'bg-gray-100 text-gray-600';
        },

        getFlipStatusDotClass(status) {
            const classes = {
                'ok': 'bg-green-500',
                'warning': 'bg-yellow-500',
                'critical': 'bg-red-500',
                'never': 'bg-gray-400'
            };
            return classes[status] || 'bg-gray-400';
        },

        getFlipStatusLabel(status, daysSince) {
            if (status === 'never') return 'Never flipped';
            if (daysSince === 0) return 'Flipped today';
            if (daysSince === 1) return 'Flipped yesterday';
            return `${daysSince} days since flip`;
        },

        async fetchRepositoryMetadata() {
            if (!this.editForm.repository || !this.editForm.repository_stock_id) return;

            this.fetchingMetadata = true;
            try {
                const response = await fetch(
                    `/api/stocks/repository-metadata/${this.editForm.repository}/${this.editForm.repository_stock_id}`,
                    { credentials: 'include' }
                );
                if (response.ok) {
                    const data = await response.json();
                    if (data.found) {
                        this.repositoryGenotype = data.genotype;
                        this.repositoryMetadata = data.metadata;
                    } else {
                        alert(data.message || 'Stock not found in repository');
                    }
                } else {
                    const error = await response.json();
                    alert('Error fetching metadata: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error fetching repository metadata:', error);
                alert('Error fetching repository metadata');
            } finally {
                this.fetchingMetadata = false;
            }
        },

        useRepositoryGenotype() {
            if (this.repositoryGenotype) {
                // Store current genotype as original if different
                if (this.editForm.genotype && this.editForm.genotype !== this.repositoryGenotype) {
                    this.editForm.original_genotype = this.editForm.genotype;
                }
                this.editForm.genotype = this.repositoryGenotype;
            }
        },

        keepCurrentGenotype() {
            // Store repository genotype as the original
            if (this.repositoryGenotype) {
                this.editForm.original_genotype = this.repositoryGenotype;
            }
            this.repositoryGenotype = null;
        },

        async suggestShortname() {
            if (!this.editForm.genotype) return;
            this.suggestingShortname = true;
            try {
                const response = await fetch('/api/stocks/suggest-shortname', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ genotype: this.editForm.genotype })
                });
                if (response.ok) {
                    const data = await response.json();
                    this.editForm.shortname = data.shortname;
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to suggest shortname');
                }
            } catch (error) {
                console.error('Error suggesting shortname:', error);
                alert('Failed to suggest shortname');
            } finally {
                this.suggestingShortname = false;
            }
        },

        async createTag() {
            const name = this.newTagName.trim();
            if (!name) return;
            try {
                const response = await fetch('/api/stocks/tags/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ name: name, color: this.newTagColor })
                });
                if (response.ok) {
                    const tag = await response.json();
                    this.allTags.push(tag);
                    this.editForm.tag_ids.push(tag.id);
                    this.newTagName = '';
                    this.newTagColor = '#6b7280';
                    this.showNewTagForm = false;
                } else {
                    const error = await response.json();
                    alert('Error creating tag: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error creating tag:', error);
                alert('Error creating tag');
            }
        },

        async loadStock() {
            this.loading = true;
            try {
                const response = await fetch('/api/stocks/{{ stock_id }}', {
                    credentials: 'include'
                });
                if (response.ok) {
                    this.stock = await response.json();
                    this.resetForm();
                } else {
                    this.error = true;
                }
            } catch (error) {
                console.error('Error loading stock:', error);
                this.error = true;
            } finally {
                this.loading = false;
            }
        },

        async loadTrays() {
            try {
                const response = await fetch('/api/trays', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    this.trays = data.items || data || [];
                }
            } catch (error) {
                console.error('Error loading trays:', error);
            }
        },

        async loadUsers() {
            try {
                const response = await fetch('/api/tenants/users', { credentials: 'include' });
                if (response.ok) {
                    this.users = await response.json();
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        },

        async loadTags() {
            try {
                const response = await fetch('/api/stocks/tags/', { credentials: 'include' });
                if (response.ok) {
                    this.allTags = await response.json();
                }
            } catch (error) {
                console.error('Error loading tags:', error);
            }
        },

        async loadCollaborators() {
            try {
                const response = await fetch('/api/collaborators', { credentials: 'include' });
                if (response.ok) {
                    this.collaborators = await response.json();
                }
            } catch (error) {
                console.error('Error loading collaborators:', error);
            }
        },

        resetForm() {
            this.clearRepositoryMetadata();
            if (this.stock) {
                this.editForm = {
                    stock_id: this.stock.stock_id || '',
                    genotype: this.stock.genotype || '',
                    shortname: this.stock.shortname || '',
                    origin: this.stock.origin || 'internal',
                    repository: this.stock.repository || '',
                    repository_stock_id: this.stock.repository_stock_id || '',
                    external_source: this.stock.external_source || '',
                    original_genotype: this.stock.original_genotype || '',
                    tray_id: this.stock.tray?.id || '',
                    position: this.stock.position || '',
                    owner_id: this.stock.owner?.id || '',
                    visibility: this.stock.visibility || 'lab_only',
                    notes: this.stock.notes || '',
                    tag_ids: (this.stock.tags || []).map(t => t.id),
                    shared_with_tenant_ids: [...(this.stock.shared_with_tenant_ids || [])]
                };
            }
        },

        async saveStock() {
            this.saving = true;
            try {
                const payload = {
                    stock_id: this.editForm.stock_id,
                    genotype: this.editForm.genotype,
                    shortname: this.editForm.shortname || null,
                    origin: this.editForm.origin,
                    repository: this.editForm.origin === 'repository' ? this.editForm.repository : null,
                    repository_stock_id: this.editForm.origin === 'repository' ? this.editForm.repository_stock_id : null,
                    external_source: this.editForm.origin === 'external' ? this.editForm.external_source : null,
                    original_genotype: this.editForm.origin === 'repository' ? this.editForm.original_genotype : null,
                    tray_id: this.editForm.tray_id || null,
                    position: this.editForm.position || null,
                    owner_id: this.editForm.owner_id || null,
                    visibility: this.editForm.visibility,
                    notes: this.editForm.notes || null,
                    tag_ids: this.editForm.tag_ids,
                    shared_with_tenant_ids: this.editForm.shared_with_tenant_ids
                };

                const response = await fetch('/api/stocks/{{ stock_id }}', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    this.stock = await response.json();
                    this.editing = false;
                    this.resetForm();
                } else {
                    const error = await response.json();
                    alert('Error saving: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving stock:', error);
                alert('Error saving stock');
            } finally {
                this.saving = false;
            }
        },

        async markAsDead() {
            if (!confirm('Mark this stock as dead? It will be hidden from regular browsing but can be restored later.')) return;
            try {
                const response = await fetch('/api/stocks/{{ stock_id }}', {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (response.ok) {
                    this.stock.is_active = false;
                    this.editing = false;
                }
            } catch (error) {
                console.error('Error marking stock as dead:', error);
            }
        },

        async restoreStock() {
            try {
                const response = await fetch('/api/stocks/{{ stock_id }}/restore', {
                    method: 'POST',
                    credentials: 'include'
                });
                if (response.ok) {
                    this.stock = await response.json();
                    this.resetForm();
                }
            } catch (error) {
                console.error('Error restoring stock:', error);
            }
        },

        formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString();
        },

        getOriginLabel(origin) {
            const labels = {
                'internal': 'Internal',
                'repository': 'Repository',
                'external': 'External'
            };
            return labels[origin] || origin;
        },

        getOriginBadgeClass(origin) {
            const classes = {
                'internal': 'bg-green-100 text-green-800',
                'repository': 'bg-blue-100 text-blue-800',
                'external': 'bg-purple-100 text-purple-800'
            };
            return classes[origin] || 'bg-gray-100 text-gray-800';
        },

        getVisibilityLabel(visibility) {
            const labels = {
                'lab_only': 'Lab Only',
                'organization': 'Organization',
                'public': 'Public'
            };
            return labels[visibility] || visibility;
        },

        getVisibilityBadgeClass(visibility) {
            const classes = {
                'lab_only': 'bg-gray-100 text-gray-800',
                'organization': 'bg-yellow-100 text-yellow-800',
                'public': 'bg-green-100 text-green-800'
            };
            return classes[visibility] || 'bg-gray-100 text-gray-800';
        },

        getStockCenterUrl(repository, stockId) {
            const urls = {
                'bdsc': `https://bdsc.indiana.edu/Home/Search?SearchTerms=${stockId}`,
                'vdrc': `https://stockcenter.vdrc.at/control/product/~VIEW_INDEX~0/~VIEW_SIZE~100/~product_id~${stockId}`,
                'kyoto': `https://kyotofly.kit.jp/cgi-bin/stocks/search_res_det.cgi?DB_NUM=1&DESSION_ID=0&STOCK_NO=${stockId}`,
                'nig': `https://shigen.nig.ac.jp/fly/nigfly/stock?stockId=${stockId}`,
                'dgrc': `https://dgrc.bio.indiana.edu/product/View?product=${stockId}`,
                'trip': `https://fgr.hms.harvard.edu/fly-in-stock?search=${stockId}`,
            };
            return urls[repository] || `https://flybase.org/search/${(repository || '').toUpperCase()}:${stockId}`;
        }
    }
}
</script>
{% endblock %}
