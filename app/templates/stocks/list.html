{% extends "base.html" %}

{% block content %}
<div class="mb-6 flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-semibold text-gray-900">Stocks</h1>
        <p class="mt-1 text-sm text-gray-500">Manage your fly stock collection</p>
    </div>
    <a href="/stocks/new" class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
        <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
        </svg>
        Add Stock
    </a>
</div>

<!-- Search and filters -->
<div class="mb-6 bg-white shadow rounded-lg p-4" x-data="stockSearch()">
    <form class="flex gap-4" @submit.prevent="search()">
        <div class="flex-1">
            <input type="text" x-model="query" placeholder="Search by stock ID or genotype..."
                   class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
        </div>
        <button type="submit" class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
            Search
        </button>
        <button type="button" @click="toggleDead()"
                :class="showDead ? 'bg-red-50 text-red-700 ring-red-300' : 'bg-white text-gray-700 ring-gray-300'"
                class="inline-flex items-center rounded-md px-3 py-2 text-sm font-semibold shadow-sm ring-1 ring-inset hover:bg-gray-50">
            <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>
            <span x-text="showDead ? 'Showing Dead' : 'Show Dead'"></span>
        </button>
    </form>
</div>

<!-- Active Filters Display -->
<div x-data="activeFilters()" x-show="hasFilters()" class="mb-4 flex gap-2 items-center">
    <span class="text-sm text-gray-600">Filters:</span>
    <template x-if="showDead">
        <span class="inline-flex items-center gap-1 rounded-full bg-red-100 px-3 py-1 text-sm text-red-800">
            Showing dead stocks
            <button @click="clearFilter('dead')" class="ml-1 text-red-600 hover:text-red-800">&times;</button>
        </span>
    </template>
    <template x-if="trayName">
        <div class="inline-flex items-center gap-2">
            <span class="inline-flex items-center gap-1 rounded-full bg-blue-100 px-3 py-1 text-sm">
                Tray: <span x-text="trayName" class="font-medium"></span>
                <button @click="clearFilter('tray')" class="ml-1 text-blue-600 hover:text-blue-800">&times;</button>
            </span>
            <button @click="printTrayLabel()"
                    title="Print Tray Label"
                    class="inline-flex items-center gap-1.5 rounded-md bg-white px-2.5 py-1.5 text-sm font-medium text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-primary-50 hover:text-primary-700 hover:ring-primary-300 transition-colors">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                </svg>
                Print Label
            </button>
        </div>
    </template>
    <template x-if="tagName">
        <span class="inline-flex items-center gap-1 rounded-full bg-purple-100 px-3 py-1 text-sm">
            Tag: <span x-text="tagName" class="font-medium"></span>
            <button @click="clearFilter('tag')" class="ml-1 text-purple-600 hover:text-purple-800">&times;</button>
        </span>
    </template>
</div>

<!-- Stocks list -->
<div id="stocks-list" x-data="stocksList()" x-init="loadStocks()">
    <template x-if="loading">
        <div class="animate-pulse bg-white shadow rounded-lg p-6">
            <div class="h-4 bg-gray-200 rounded w-1/4 mb-4"></div>
            <div class="space-y-3">
                <div class="h-4 bg-gray-200 rounded"></div>
                <div class="h-4 bg-gray-200 rounded"></div>
                <div class="h-4 bg-gray-200 rounded"></div>
            </div>
        </div>
    </template>

    <template x-if="!loading && error">
        <div class="bg-red-50 border border-red-200 shadow rounded-lg p-6 text-center">
            <svg class="mx-auto h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <h3 class="mt-2 text-sm font-semibold text-gray-900">Error Loading Stocks</h3>
            <p class="mt-1 text-sm text-gray-600" x-text="error"></p>
            <div class="mt-6">
                <button @click="loadStocks()" class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                    Retry
                </button>
            </div>
        </div>
    </template>

    <template x-if="!loading && !error && stocks.length === 0">
        <div class="bg-white shadow rounded-lg p-6 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
            </svg>
            <template x-if="showDead">
                <div>
                    <h3 class="mt-2 text-sm font-semibold text-gray-900">No dead stocks</h3>
                    <p class="mt-1 text-sm text-gray-500">All your stocks are alive and well.</p>
                </div>
            </template>
            <template x-if="!showDead">
                <div>
                    <h3 class="mt-2 text-sm font-semibold text-gray-900">No stocks</h3>
                    <p class="mt-1 text-sm text-gray-500">Get started by creating a new stock.</p>
                    <div class="mt-6">
                        <a href="/stocks/new" class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                            <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                            </svg>
                            Add Stock
                        </a>
                    </div>
                </div>
            </template>
        </div>
    </template>

    <template x-if="!loading && !error && stocks.length > 0">
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <!-- Bulk Actions Toolbar -->
            <div x-show="selectedStocks.length > 0" class="bg-blue-50 border-b border-blue-200 px-4 py-3">
                <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-sm font-medium text-blue-900">
                        <template x-if="selectAllPages">
                            <span>All <span x-text="total"></span> stocks selected</span>
                        </template>
                        <template x-if="!selectAllPages">
                            <span><span x-text="selectedStocks.length"></span> selected</span>
                        </template>
                    </span>
                    <button @click="clearSelection()" class="text-sm text-blue-600 hover:text-blue-800">Clear</button>
                </div>
                <div class="flex items-center gap-2">
                    <select x-model="bulkAction" class="rounded-md border-gray-300 text-sm">
                        <option value="">Choose action...</option>
                        <option value="visibility">Change Visibility</option>
                        <option value="add-tags">Add Tags</option>
                        <option value="remove-tags">Remove Tags</option>
                        <option value="change-tray">Change Tray</option>
                        <option value="change-owner">Change Owner</option>
                    </select>
                    <button @click="executeBulkAction()" :disabled="!bulkAction"
                            class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        Apply
                    </button>
                </div>
                </div>
                <!-- Select all across pages banner -->
                <template x-if="!selectAllPages && selectedStocks.length === stocks.length && total > stocks.length">
                    <div class="mt-2 text-sm text-blue-800">
                        All <span x-text="stocks.length"></span> stocks on this page are selected.
                        <button @click="selectAllMatching()" class="font-semibold underline hover:text-blue-900">
                            Select all <span x-text="total"></span> stocks matching this filter
                        </button>
                    </div>
                </template>
            </div>

            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-3 py-3 text-left w-10">
                            <input type="checkbox"
                                   @change="toggleSelectAll()"
                                   :checked="selectAllPages || (selectedStocks.length === stocks.length && stocks.length > 0)"
                                   :indeterminate="!selectAllPages && selectedStocks.length > 0 && selectedStocks.length < stocks.length"
                                   class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        </th>
                        <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10" title="Flip Status">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </th>
                        <th scope="col" @click="sortBy('stock_id')" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            <div class="flex items-center gap-1">
                                Stock ID
                                <span x-show="currentSort === 'stock_id'" x-html="sortIcon()"></span>
                            </div>
                        </th>
                        <th scope="col" @click="sortBy('genotype')" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            <div class="flex items-center gap-1">
                                Genotype
                                <span x-show="currentSort === 'genotype'" x-html="sortIcon()"></span>
                            </div>
                        </th>
                        <th scope="col" @click="sortBy('repository')" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            <div class="flex items-center gap-1">
                                Source
                                <span x-show="currentSort === 'repository'" x-html="sortIcon()"></span>
                            </div>
                        </th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                        <th scope="col" @click="sortBy('last_flip_at')" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            <div class="flex items-center gap-1">
                                Last Flip
                                <span x-show="currentSort === 'last_flip_at'" x-html="sortIcon()"></span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="stock in stocks" :key="stock.id">
                        <tr class="hover:bg-gray-50" :class="{'bg-blue-50': selectedStocks.includes(stock.id), 'opacity-60': !stock.is_active}">
                            <td class="px-3 py-4 whitespace-nowrap">
                                <input type="checkbox"
                                       :value="stock.id"
                                       @change="toggleStock(stock.id)"
                                       :checked="selectedStocks.includes(stock.id)"
                                       class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                            </td>
                            <td class="px-3 py-4 whitespace-nowrap">
                                <div class="relative group">
                                    <span class="inline-block h-3 w-3 rounded-full cursor-help"
                                          :class="getFlipStatusDotClass(stock.flip_status)"></span>
                                    <!-- Tooltip -->
                                    <div class="absolute left-6 top-1/2 -translate-y-1/2 hidden group-hover:block z-10 px-2 py-1 text-xs text-white bg-gray-900 rounded whitespace-nowrap">
                                        <span x-text="getFlipTooltip(stock.flip_status, stock.days_since_flip)"></span>
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="flex items-center gap-2">
                                    <a :href="getStockDetailUrl(stock.id)" class="text-primary-600 hover:text-primary-900 font-medium" x-text="stock.stock_id"></a>
                                    <span x-show="stock.is_placeholder" class="inline-flex items-center rounded-full bg-yellow-100 px-2 py-0.5 text-xs font-medium text-yellow-800">Pending</span>
                                    <span x-show="!stock.is_active" class="inline-flex items-center rounded-full bg-red-100 px-2 py-0.5 text-xs font-medium text-red-700">Dead</span>
                                </div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="text-sm text-gray-900 max-w-sm truncate" x-text="stock.genotype"></div>
                                <div x-show="stock.shortname" class="text-xs text-gray-500 mt-0.5" x-text="stock.shortname"></div>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500" x-text="stock.repository ? stock.repository.toUpperCase() : '-'"></td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500" x-text="stock.tray?.name || '-'"></td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500" x-text="stock.last_flip_at ? new Date(stock.last_flip_at).toLocaleDateString() : 'Never'"></td>
                        </tr>
                    </template>
                </tbody>
            </table>

            <!-- Pagination -->
            <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                <div class="flex-1 flex justify-between sm:hidden">
                    <button @click="prevPage()" :disabled="page === 1" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">Previous</button>
                    <button @click="nextPage()" :disabled="page * pageSize >= total" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">Next</button>
                </div>
                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div class="flex items-center gap-4">
                        <p class="text-sm text-gray-700">
                            Showing <span class="font-medium" x-text="(page - 1) * pageSize + 1"></span> to <span class="font-medium" x-text="Math.min(page * pageSize, total)"></span> of <span class="font-medium" x-text="total"></span> results
                        </p>
                        <div class="flex items-center gap-1.5">
                            <label class="text-sm text-gray-500">Show</label>
                            <select @change="changePageSize($event.target.value)"
                                    :value="pageSize"
                                    class="rounded-md border-gray-300 py-1 pl-2 pr-7 text-sm focus:border-primary-500 focus:ring-primary-500">
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span class="text-sm text-gray-500">per page</span>
                        </div>
                    </div>
                    <div x-show="total > pageSize">
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                            <button @click="prevPage()" :disabled="page === 1" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                                <span class="sr-only">Previous</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                            </button>
                            <button @click="nextPage()" :disabled="page * pageSize >= total" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                                <span class="sr-only">Next</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                            </button>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </template>
</div>

<!-- Bulk Actions Modals -->
<div x-data="bulkActionsHandler()">
    <!-- Change Visibility Modal -->
    <div x-show="showModal === 'visibility'" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex min-h-screen items-center justify-center p-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="closeModal()"></div>
            <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Change Visibility</h3>
                <form @submit.prevent="applyVisibility()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">New Visibility</label>
                        <select x-model="formData.visibility" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                            <option value="lab_only">Lab Only</option>
                            <option value="organization">Organization</option>
                            <option value="public">Public</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" @click="closeModal()" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="submit" :disabled="saving" class="rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-500 disabled:opacity-50">
                            <span x-show="!saving">Apply to <span x-text="stockIds.length"></span> stocks</span>
                            <span x-show="saving">Applying...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Tags Modal -->
    <div x-show="showModal === 'add-tags'" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex min-h-screen items-center justify-center p-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="closeModal()"></div>
            <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Add Tags</h3>
                <form @submit.prevent="applyAddTags()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Tags to Add</label>
                        <div class="max-h-60 overflow-y-auto border border-gray-200 rounded-md p-3 space-y-2">
                            <template x-for="tag in availableTags" :key="tag.id">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" :value="tag.id" x-model="formData.tagIds" class="rounded border-gray-300 text-primary-600">
                                    <span class="text-sm" x-text="tag.name"></span>
                                </label>
                            </template>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" @click="closeModal()" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="submit" :disabled="saving || formData.tagIds.length === 0" class="rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-500 disabled:opacity-50">
                            <span x-show="!saving">Add to <span x-text="stockIds.length"></span> stocks</span>
                            <span x-show="saving">Adding...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Remove Tags Modal -->
    <div x-show="showModal === 'remove-tags'" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex min-h-screen items-center justify-center p-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="closeModal()"></div>
            <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Remove Tags</h3>
                <form @submit.prevent="applyRemoveTags()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Tags to Remove</label>
                        <div class="max-h-60 overflow-y-auto border border-gray-200 rounded-md p-3 space-y-2">
                            <template x-for="tag in availableTags" :key="tag.id">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" :value="tag.id" x-model="formData.tagIds" class="rounded border-gray-300 text-primary-600">
                                    <span class="text-sm" x-text="tag.name"></span>
                                </label>
                            </template>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" @click="closeModal()" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="submit" :disabled="saving || formData.tagIds.length === 0" class="rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-500 disabled:opacity-50">
                            <span x-show="!saving">Remove from <span x-text="stockIds.length"></span> stocks</span>
                            <span x-show="saving">Removing...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Tray Modal -->
    <div x-show="showModal === 'change-tray'" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex min-h-screen items-center justify-center p-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="closeModal()"></div>
            <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Change Tray</h3>
                <form @submit.prevent="applyChangeTray()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Tray</label>
                        <select x-model="formData.trayId" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                            <option value="">No Tray (Remove from tray)</option>
                            <template x-for="tray in availableTrays" :key="tray.id">
                                <option :value="tray.id" x-text="tray.name"></option>
                            </template>
                        </select>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" @click="closeModal()" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="submit" :disabled="saving" class="rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-500 disabled:opacity-50">
                            <span x-show="!saving">Apply to <span x-text="stockIds.length"></span> stocks</span>
                            <span x-show="saving">Applying...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Owner Modal -->
    <div x-show="showModal === 'change-owner'" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex min-h-screen items-center justify-center p-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="closeModal()"></div>
            <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Change Owner</h3>
                <form @submit.prevent="applyChangeOwner()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Owner</label>
                        <select x-model="formData.ownerId" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                            <option value="">No Owner</option>
                            <template x-for="user in availableUsers" :key="user.id">
                                <option :value="user.id" x-text="user.full_name"></option>
                            </template>
                        </select>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" @click="closeModal()" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="submit" :disabled="saving" class="rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-500 disabled:opacity-50">
                            <span x-show="!saving">Apply to <span x-text="stockIds.length"></span> stocks</span>
                            <span x-show="saving">Applying...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function stockSearch() {
    return {
        query: '',
        showDead: new URLSearchParams(window.location.search).get('dead') === '1',
        search() {
            window.dispatchEvent(new CustomEvent('stocks-search', { detail: { query: this.query, showDead: this.showDead } }));
        },
        toggleDead() {
            this.showDead = !this.showDead;
            this.search();
        }
    }
}

function stocksList() {
    return {
        loading: true,
        stocks: [],
        total: 0,
        page: 1,
        pageSize: parseInt(localStorage.getItem('stocks_page_size') || '50'),
        query: '',
        showDead: false,
        currentSort: 'modified_at',
        sortOrder: 'desc',
        tagFilter: '',
        trayFilter: '',
        error: null,
        selectedStocks: [],
        selectAllPages: false,
        bulkAction: '',
        init() {
            // Read URL parameters on page load
            const urlParams = new URLSearchParams(window.location.search);
            this.tagFilter = urlParams.get('tag') || '';
            this.trayFilter = urlParams.get('tray') || '';
            this.showDead = urlParams.get('dead') === '1';

            // Listen for search events
            window.addEventListener('stocks-search', (e) => {
                this.query = e.detail.query;
                this.showDead = e.detail.showDead || false;
                this.page = 1;
                this.loadStocks();
            });
        },
        async loadStocks() {
            this.loading = true;
            this.error = null;
            try {
                const params = new URLSearchParams({
                    page: this.page,
                    page_size: this.pageSize,
                });

                // Only add sort params if not default
                if (this.currentSort && this.currentSort !== 'modified_at') {
                    params.append('sort_by', this.currentSort);
                }
                if (this.sortOrder && this.sortOrder !== 'desc') {
                    params.append('sort_order', this.sortOrder);
                }

                if (this.query) params.append('query', this.query);
                if (this.tagFilter) params.append('tag_ids', this.tagFilter);
                if (this.trayFilter) params.append('tray_id', this.trayFilter);
                if (this.showDead) params.append('is_active', 'false');

                const response = await fetch('/api/stocks?' + params.toString(), {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    this.stocks = data.items || [];
                    this.total = data.total || 0;
                } else {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    this.error = `API Error: ${errorData.detail || response.statusText}`;
                    console.error('API Error:', errorData);
                }

                // Update URL without page reload
                this.updateURL();
            } catch (error) {
                this.error = `Error loading stocks: ${error.message}`;
                console.error('Error loading stocks:', error);
            } finally {
                this.loading = false;
            }
        },
        sortBy(field) {
            if (this.currentSort === field) {
                // Toggle sort order
                this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                // New field, default to ascending
                this.currentSort = field;
                this.sortOrder = 'asc';
            }
            this.page = 1;
            this.loadStocks();
        },
        sortIcon() {
            return this.sortOrder === 'asc'
                ? '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>'
                : '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z"/></svg>';
        },
        updateURL() {
            const params = new URLSearchParams();
            if (this.tagFilter) params.set('tag', this.tagFilter);
            if (this.trayFilter) params.set('tray', this.trayFilter);
            if (this.query) params.set('query', this.query);
            if (this.showDead) params.set('dead', '1');

            const newURL = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
            history.pushState({}, '', newURL);
        },
        prevPage() {
            if (this.page > 1) {
                this.page--;
                this.clearSelection();
                this.loadStocks();
            }
        },
        nextPage() {
            if (this.page * this.pageSize < this.total) {
                this.page++;
                this.clearSelection();
                this.loadStocks();
            }
        },
        getStockDetailUrl(stockId) {
            const params = new URLSearchParams();
            if (this.query) params.set('q', this.query);
            if (this.currentSort && this.currentSort !== 'modified_at') params.set('sort_by', this.currentSort);
            if (this.sortOrder && this.sortOrder !== 'desc') params.set('sort_order', this.sortOrder);
            if (this.tagFilter) params.set('tag_ids', this.tagFilter);
            if (this.trayFilter) params.set('tray_id', this.trayFilter);
            const qs = params.toString();
            return '/stocks/' + stockId + (qs ? '?' + qs : '');
        },
        getFlipStatusDotClass(status) {
            const classes = {
                'ok': 'bg-green-500',
                'warning': 'bg-yellow-500',
                'critical': 'bg-red-500',
                'never': 'bg-gray-300'
            };
            return classes[status] || 'bg-gray-300';
        },
        getFlipTooltip(status, daysSince) {
            if (status === 'never' || !status) return 'Never flipped';
            if (daysSince === 0) return 'Flipped today';
            if (daysSince === 1) return 'Flipped yesterday';
            if (status === 'critical') return `${daysSince} days - needs immediate attention!`;
            if (status === 'warning') return `${daysSince} days - flip soon`;
            return `${daysSince} days since flip`;
        },
        toggleStock(stockId) {
            const index = this.selectedStocks.indexOf(stockId);
            if (index > -1) {
                this.selectedStocks.splice(index, 1);
                this.selectAllPages = false;
            } else {
                this.selectedStocks.push(stockId);
            }
        },
        toggleSelectAll() {
            if (this.selectedStocks.length === this.stocks.length) {
                this.selectedStocks = [];
                this.selectAllPages = false;
            } else {
                this.selectedStocks = this.stocks.map(s => s.id);
            }
        },
        async selectAllMatching() {
            // Fetch all stock IDs matching current filters
            try {
                const params = new URLSearchParams({
                    page: 1,
                    page_size: this.total,
                });
                if (this.currentSort && this.currentSort !== 'modified_at') params.append('sort_by', this.currentSort);
                if (this.sortOrder && this.sortOrder !== 'desc') params.append('sort_order', this.sortOrder);
                if (this.query) params.append('query', this.query);
                if (this.tagFilter) params.append('tag_ids', this.tagFilter);
                if (this.trayFilter) params.append('tray_id', this.trayFilter);
                if (this.showDead) params.append('is_active', 'false');

                const response = await fetch('/api/stocks?' + params.toString(), { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    this.selectedStocks = (data.items || []).map(s => s.id);
                    this.selectAllPages = true;
                }
            } catch (error) {
                console.error('Error fetching all stock IDs:', error);
            }
        },
        clearSelection() {
            this.selectedStocks = [];
            this.selectAllPages = false;
            this.bulkAction = '';
        },
        changePageSize(newSize) {
            this.pageSize = parseInt(newSize);
            localStorage.setItem('stocks_page_size', newSize);
            this.page = 1;
            this.clearSelection();
            this.loadStocks();
        },
        executeBulkAction() {
            if (!this.bulkAction || this.selectedStocks.length === 0) return;

            // Dispatch event to open appropriate modal
            window.dispatchEvent(new CustomEvent('bulk-action', {
                detail: {
                    action: this.bulkAction,
                    stockIds: this.selectedStocks
                }
            }));
        }
    }
}

function activeFilters() {
    return {
        trayName: null,
        trayId: null,
        tagName: null,
        showDead: false,
        init() {
            const urlParams = new URLSearchParams(window.location.search);
            this.trayId = urlParams.get('tray');
            const tagId = urlParams.get('tag');
            this.showDead = urlParams.get('dead') === '1';

            // Fetch tray/tag names if we have IDs
            if (this.trayId) this.fetchTrayName(this.trayId);
            if (tagId) this.fetchTagName(tagId);
        },
        hasFilters() {
            return this.trayName || this.tagName || this.showDead;
        },
        async fetchTrayName(trayId) {
            try {
                const response = await fetch(`/api/trays/${trayId}`, { credentials: 'include' });
                if (response.ok) {
                    const tray = await response.json();
                    this.trayName = tray.name;
                }
            } catch (e) {
                console.error('Failed to fetch tray name:', e);
            }
        },
        async fetchTagName(tagId) {
            try {
                const response = await fetch('/api/stocks/tags/', { credentials: 'include' });
                if (response.ok) {
                    const tags = await response.json();
                    const tag = tags.find(t => t.id === tagId);
                    if (tag) this.tagName = tag.name;
                }
            } catch (e) {
                console.error('Failed to fetch tag name:', e);
            }
        },
        async printTrayLabel() {
            if (!this.trayId) return;
            try {
                const statusResp = await fetch('/api/labels/agents/status/online', { credentials: 'include' });
                const statusData = await statusResp.json();
                if (statusData.has_online_agent) {
                    await fetch('/api/labels/print-tray', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ tray_id: this.trayId })
                    });
                } else {
                    window.open(`/api/labels/tray/${this.trayId}/pdf`, '_blank');
                }
            } catch (error) {
                console.error('Error printing tray label:', error);
            }
        },
        clearFilter(type) {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.delete(type);
            const newURL = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
            window.location.href = newURL;
        }
    }
}

function bulkActionsHandler() {
    return {
        showModal: null,
        stockIds: [],
        saving: false,
        availableTags: [],
        availableTrays: [],
        availableUsers: [],
        formData: {
            visibility: 'lab_only',
            tagIds: [],
            trayId: '',
            ownerId: ''
        },

        init() {
            // Listen for bulk action events
            window.addEventListener('bulk-action', (e) => {
                this.stockIds = e.detail.stockIds;
                this.showModal = e.detail.action;
                this.resetFormData();

                // Load dropdown data based on action
                if (e.detail.action === 'add-tags' || e.detail.action === 'remove-tags') {
                    this.loadTags();
                } else if (e.detail.action === 'change-tray') {
                    this.loadTrays();
                } else if (e.detail.action === 'change-owner') {
                    this.loadUsers();
                }
            });
        },

        resetFormData() {
            this.formData = {
                visibility: 'lab_only',
                tagIds: [],
                trayId: '',
                ownerId: ''
            };
        },

        closeModal() {
            this.showModal = null;
            this.stockIds = [];
            this.resetFormData();
        },

        async loadTags() {
            try {
                const response = await fetch('/api/stocks/tags/', { credentials: 'include' });
                if (response.ok) {
                    this.availableTags = await response.json();
                }
            } catch (e) {
                console.error('Failed to load tags:', e);
            }
        },

        async loadTrays() {
            try {
                const response = await fetch('/api/trays?page=1&page_size=100', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    this.availableTrays = data.items || [];
                }
            } catch (e) {
                console.error('Failed to load trays:', e);
            }
        },

        async loadUsers() {
            try {
                const response = await fetch('/api/users?page=1&page_size=100', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    this.availableUsers = data.items || [];
                }
            } catch (e) {
                console.error('Failed to load users:', e);
            }
        },

        async applyVisibility() {
            this.saving = true;
            try {
                const response = await fetch('/api/stocks/bulk/visibility', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        stock_ids: this.stockIds,
                        visibility: this.formData.visibility
                    })
                });

                if (response.ok) {
                    this.closeModal();
                    window.dispatchEvent(new CustomEvent('stocks-search', { detail: { query: '' } }));
                    alert('Visibility updated successfully');
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to update visibility'));
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Failed to update visibility');
            } finally {
                this.saving = false;
            }
        },

        async applyAddTags() {
            this.saving = true;
            try {
                const response = await fetch('/api/stocks/bulk/add-tags', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        stock_ids: this.stockIds,
                        tag_ids: this.formData.tagIds
                    })
                });

                if (response.ok) {
                    this.closeModal();
                    window.dispatchEvent(new CustomEvent('stocks-search', { detail: { query: '' } }));
                    alert('Tags added successfully');
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to add tags'));
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Failed to add tags');
            } finally {
                this.saving = false;
            }
        },

        async applyRemoveTags() {
            this.saving = true;
            try {
                const response = await fetch('/api/stocks/bulk/remove-tags', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        stock_ids: this.stockIds,
                        tag_ids: this.formData.tagIds
                    })
                });

                if (response.ok) {
                    this.closeModal();
                    window.dispatchEvent(new CustomEvent('stocks-search', { detail: { query: '' } }));
                    alert('Tags removed successfully');
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to remove tags'));
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Failed to remove tags');
            } finally {
                this.saving = false;
            }
        },

        async applyChangeTray() {
            this.saving = true;
            try {
                const response = await fetch('/api/stocks/bulk/change-tray', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        stock_ids: this.stockIds,
                        tray_id: this.formData.trayId || null
                    })
                });

                if (response.ok) {
                    this.closeModal();
                    window.dispatchEvent(new CustomEvent('stocks-search', { detail: { query: '' } }));
                    alert('Tray changed successfully');
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to change tray'));
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Failed to change tray');
            } finally {
                this.saving = false;
            }
        },

        async applyChangeOwner() {
            this.saving = true;
            try {
                const response = await fetch('/api/stocks/bulk/change-owner', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        stock_ids: this.stockIds,
                        owner_id: this.formData.ownerId || null
                    })
                });

                if (response.ok) {
                    this.closeModal();
                    window.dispatchEvent(new CustomEvent('stocks-search', { detail: { query: '' } }));
                    alert('Owner changed successfully');
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to change owner'));
                }
            } catch (e) {
                console.error('Error:', e);
                alert('Failed to change owner');
            } finally {
                this.saving = false;
            }
        }
    }
}
</script>
{% endblock %}
