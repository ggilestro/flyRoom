name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mariadb:
        image: mariadb:10.11
        env:
          MARIADB_ROOT_PASSWORD: testpassword
          MARIADB_DATABASE: flypush_test
          MARIADB_USER: flypush
          MARIADB_PASSWORD: testpassword
        ports:
          - 3306:3306
        options: >-
          --health-cmd="healthcheck.sh --connect --innodb_initialized"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Wait for MariaDB
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -u root -ptestpassword --silent; then
              break
            fi
            sleep 1
          done

      - name: Run tests
        env:
          DATABASE_URL: mysql+pymysql://flypush:testpassword@127.0.0.1:3306/flypush_test
          SECRET_KEY: test-secret-key-for-ci-only-not-production
          DEBUG: "true"
        run: |
          pytest --cov=app --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Pin versions to match pre-commit config for consistency
          pip install 'ruff>=0.15.0' black mypy

      - name: Check formatting with Black
        run: black --check .

      - name: Lint with Ruff
        run: ruff check .

  docker:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t flypush:test .

      - name: Test Docker image starts
        run: |
          docker run -d --name flypush-test -p 8000:8000 \
            -e DATABASE_URL=sqlite:///./test.db \
            -e SECRET_KEY=test-secret-key \
            flypush:test || true
          sleep 5
          docker logs flypush-test
          docker stop flypush-test || true
